<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ZhiliuOS Multi-Terminal Pro</title>
    <script src="coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap');

        :root {
            --bg-color: #0c0c0c;
            --window-bg: #1e1e1e;
            --text-color: #fff;
            --bar-bg: #333a;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --transition-ease: cubic-bezier(0.16, 1, 0.3, 1);
            --main-shadow: 0 20px 50px var(--shadow-color), 0 10px 25px var(--shadow-color), 0 0px 1.5px #0007;
        }

        * {
            font-family: "Noto Sans JP", sans-serif;
            font-optical-sizing: auto;
            font-style: normal;
            line-height: 1.5 !important;
        }

        span {
            font-family: "Source Code Pro", monospace !important;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            font-family: sans-serif;
            height: 100vh;
            user-select: none;
        }
        
        /* 背景ターミナル（透過表示） */
        #bg-terminal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        #lottie-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            transition: opacity 0.5s ease;
        }

        .fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Hanul 2スタイルのウィンドウ */
        .window {
            position: absolute;
            top: 100px;
            left: 100px;
            width: 750px;
            height: 500px;
            min-width: 400px;
            min-height: 300px;
            background: var(--window-bg);
            border-radius: 16px;
            box-shadow: var(--main-shadow);
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: opacity 0.4s, transform 0.4s cubic-bezier(.51, 0, .5, .61);
            display: flex;
            flex-direction: column;
            overflow: visible;
            cursor: default;
        }

        .window.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
            transition: opacity 0.4s, transform 0.5s cubic-bezier(.28, .14, 0, 1);
        }

        .window-content {
            flex: 1;
            padding: 10px;
            overflow: hidden;
            cursor: default;
            color: var(--text-color);
            position: relative;
        }

        #terminal-container {
            height: 100%;
            background: var(--window-bg);
        }

        .control-bar {
            position: absolute;
            bottom: -36px;
            left: 50%;
            transform: translateX(-50%);
            height: 12px;
            background: var(--bar-bg);
            --bar-text: #0000;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 6px 0 8px;
            gap: 10px;
            width: 100px;
            cursor: grab;
            box-shadow: var(--main-shadow);
            transition: all 0.5s var(--transition-ease);
            backdrop-filter: blur(8px);
            z-index: 10;
            max-width: 80%;
            overflow: hidden;
            color: var(--bar-text);
            --close-btnbg: #0000;
        }

        .control-bar:hover {
            --bar-text: #fffb;
            --close-btnbg: #fff4;
            height: 28px;
            bottom: -40px;
            width: 140px;
        }

        .control-bar.dragging {
            cursor: grabbing;
        }

        .bar-title {
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 1;
            max-width: 200px;
            transition: max-width 0.3s, opacity 0.2s, margin 0.3s;
        }

        .close-btn-area {
            width: 16px;
            height: 16px;
            background: var(--close-btnbg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .close-btn-area:hover {
            background: #ff4444;
        }

        .close-icon {
            position: relative;
            width: 12px;
            height: 12px;
            transition: transform 0.3s;
        }

        .close-icon::before,
        .close-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #fff0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .close-icon::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        /* リサイズモード */
        .window.is-resizing .control-bar,
        .window.is-resize-hover .control-bar {
            left: 100%;
            transform: translateX(-50%);
            padding: 0;
            width: 32px;
            height: 32px;
            bottom: -40px;
            justify-content: center;
            background: #fff4;
            cursor: nwse-resize;
        }

        .window.is-resizing .bar-title,
        .window.is-resize-hover .bar-title {
            max-width: 0;
            opacity: 0;
            margin: 0;
        }

        .window.is-resizing .close-btn-area,
        .window.is-resize-hover .close-btn-area {
            background: transparent;
            pointer-events: none;
            visibility: hidden;
        }

        .window.is-resizing .close-icon,
        .window.is-resize-hover .close-icon {
            transform: rotate(90deg) scale(0.9);
        }

        .window.no-transition {
            transition: none !important;
        }

        .window.no-transition .control-bar {
            transition: none !important;
        }

        .window.no-transition .bar-title {
            transition: none !important;
        }

        body.global-resize-cursor {
            cursor: nwse-resize !important;
        }

        /* ダイアログ用のスタイル */
        .window.dialog {
            width: 400px;
            height: 200px;
            min-width: 300px;
            min-height: 150px;
            z-index: 3000;
        }

        .window.dialog .window-content {
            padding: 20px;
        }

        .window.dialog button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #444;
            color: #fff;
            cursor: pointer;
            margin-top: 15px;
        }

        .window.dialog button:hover {
            background: #555;
        }
    </style>
</head>
<body>

    <div id="lottie-overlay">
        <div id="lottie-container" style="width: 100vw; height: 100vh;"></div>
    </div>

    <div id="bg-terminal"></div>

    <div class="window active" id="main-window">
        <div class="window-content">
            <div id="terminal-container"></div>
        </div>
        <div class="control-bar">
            <span class="bar-title">ZhiliuOS Pro Terminal</span>
            <div class="close-btn-area">
                <div class="close-icon"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { WebContainer } from 'https://esm.sh/@webcontainer/api';

        const files = {
            'help.js': { file: { contents: `console.log('\\nAVAILABLE: help, HanGUI\\n')` } },
            'hangui.js': {
                file: {
                    contents: `
                    const args = process.argv.slice(2).join(' ');
                    const titleMatch = args.match(/--title\\s+"([^"]+)"/);
                    const htmlMatch = args.match(/--html\\s+"([^"]+)"/);
                    console.log('[[GUI:' + JSON.stringify({
                        title: titleMatch ? titleMatch[1] : 'Notification',
                        html: htmlMatch ? htmlMatch[1] : 'Default message'
                    }) + ']]');
                `}
            },
            'package.json': { file: { contents: '{"name":"zhiliu-os"}' } }
        };

        class WindowManager {
            constructor() {
                this.windows = new Map();
                this.zIndex = 100;
                this.RESIZE_THRESHOLD = 60;
                this.currentResizeHover = null;
                this.dialogCounter = 0;
                
                document.addEventListener('mousemove', this.handleGlobalMouseMove.bind(this));
            }

            createDialog(title, html) {
                this.dialogCounter++;
                const dialogId = `dialog-${this.dialogCounter}`;
                
                const dialog = document.createElement('div');
                dialog.className = 'window dialog';
                dialog.id = dialogId;
                dialog.style.top = '150px';
                dialog.style.left = '200px';
                
                dialog.innerHTML = `
                    <div class="window-content">
                        <h3 style="margin-top:0;">${title}</h3>
                        <div>${html}</div>
                        <button class="close-dialog-btn">閉じる</button>
                    </div>
                    <div class="control-bar">
                        <span class="bar-title">${title}</span>
                        <div class="close-btn-area">
                            <div class="close-icon"></div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                this.setupWindow(dialog);
                
                dialog.querySelector('.close-dialog-btn').addEventListener('click', () => {
                    this.closeWindow(dialog);
                });
                
                setTimeout(() => {
                    this.openWindow(dialogId);
                }, 10);
                
                return dialog;
            }

            setupWindow(win) {
                this.windows.set(win.id, win);
                this.setupResizeAndMove(win);
                this.setupCloseButton(win);
            }

            openWindow(id) {
                const win = document.getElementById(id);
                if (win) {
                    const winRect = win.getBoundingClientRect();
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    const centerX = (screenWidth - winRect.width) / 2;
                    const centerY = (screenHeight - winRect.height) / 2;

                    win.style.left = `${centerX}px`;
                    win.style.top = `${centerY}px`;

                    win.classList.add('active');
                    this.bringToFront(win);
                }
            }

            closeWindow(win) {
                win.classList.remove('active');
                win.classList.remove('is-resizing');
                win.classList.remove('is-resize-hover');
                
                setTimeout(() => {
                    if (win.classList.contains('dialog')) {
                        win.remove();
                        this.windows.delete(win.id);
                    }
                }, 400);
            }

            bringToFront(win) {
                this.zIndex++;
                win.style.zIndex = this.zIndex;
            }

            setupCloseButton(win) {
                const closeBtn = win.querySelector('.close-btn-area');
                closeBtn.addEventListener('mousedown', (e) => {
                    if (!win.classList.contains('is-resizing')) {
                        e.stopPropagation();
                        this.closeWindow(win);
                    }
                });
            }

            isNearResizeCorner(win, clientX, clientY) {
                const rect = win.getBoundingClientRect();
                const threshold = this.RESIZE_THRESHOLD;

                const distanceX = clientX - (rect.left + rect.width);
                const isNearRight = distanceX >= -threshold && distanceX <= 5;

                const distanceY = clientY - (rect.top + rect.height);
                const isNearBottom = distanceY >= -threshold && distanceY <= threshold;

                return isNearRight && isNearBottom;
            }

            handleGlobalMouseMove(e) {
                if (document.querySelector('.window.is-resizing') || document.querySelector('.control-bar.dragging')) {
                    return;
                }

                let foundHover = false;

                const activeWindows = Array.from(this.windows.values()).filter(win => win.classList.contains('active'));
                activeWindows.sort((a, b) => (parseInt(b.style.zIndex) || 0) - (parseInt(a.style.zIndex) || 0));

                for (const win of activeWindows) {
                    if (this.isNearResizeCorner(win, e.clientX, e.clientY)) {
                        if (this.currentResizeHover !== win) {
                            if (this.currentResizeHover) {
                                this.currentResizeHover.classList.remove('is-resize-hover');
                            }
                            win.classList.add('is-resize-hover');
                            this.currentResizeHover = win;
                        }
                        document.body.classList.add('global-resize-cursor');
                        foundHover = true;
                        break;
                    }
                }

                if (!foundHover) {
                    if (this.currentResizeHover) {
                        this.currentResizeHover.classList.remove('is-resize-hover');
                        this.currentResizeHover = null;
                    }
                    document.body.classList.remove('global-resize-cursor');
                }
            }

            setupResizeAndMove(win) {
                const controlBar = win.querySelector('.control-bar');

                win.addEventListener('mousedown', (e) => {
                    this.bringToFront(win);
                    win.classList.add('no-transition');

                    const startX = e.clientX;
                    const startY = e.clientY;
                    const rect = win.getBoundingClientRect();

                    const isNearCorner = this.isNearResizeCorner(win, startX, startY);
                    const isResizing = isNearCorner;
                    const isMoving = e.target.closest('.control-bar') && !isResizing;
                    const isCloseButton = e.target.closest('.close-btn-area');

                    if (!isResizing && !isMoving || isCloseButton) {
                        win.classList.remove('no-transition');
                        return;
                    }

                    if (isResizing) {
                        win.classList.add('is-resizing');
                        const startWidth = rect.width;
                        const startHeight = rect.height;
                        const minWidth = parseInt(win.style.minWidth) || 400;
                        const minHeight = parseInt(win.style.minHeight) || 300;

                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            win.style.width = `${Math.max(minWidth, startWidth + dx)}px`;
                            win.style.height = `${Math.max(minHeight, startHeight + dy)}px`;
                        };

                        const onMouseUp = () => {
                            win.classList.remove('is-resizing');
                            win.classList.remove('is-resize-hover');
                            win.classList.remove('no-transition');
                            document.body.classList.remove('global-resize-cursor');
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    } else if (isMoving) {
                        controlBar.classList.add('dragging');
                        const initialLeft = rect.left;
                        const initialTop = rect.top;

                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            win.style.left = `${initialLeft + dx}px`;
                            win.style.top = `${initialTop + dy}px`;
                        };

                        const onMouseUp = () => {
                            controlBar.classList.remove('dragging');
                            win.classList.remove('no-transition');
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    }
                });
            }
        }

        window.addEventListener('load', async () => {
            const animation = lottie.loadAnimation({
                container: document.getElementById('lottie-container'),
                renderer: 'svg',
                loop: false,
                autoplay: true,
                path: 'data.json'
            });

            const bgTerm = new Terminal({
                theme: { background: '#0c0c0c' },
                disableStdin: true
            });
            bgTerm.open(document.getElementById('bg-terminal'));

            const mainTerm = new Terminal({
                cursorBlink: true,
                fontFamily: '"Fira Code", monospace',
                theme: { background: '#1e1e1e' },
                convertEol: true
            });
            mainTerm.open(document.getElementById('terminal-container'));

            const windowManager = new WindowManager();
            const mainWindow = document.getElementById('main-window');
            windowManager.setupWindow(mainWindow);

            const [webcontainerInstance] = await Promise.all([
                WebContainer.boot(),
                new Promise(resolve => animation.onComplete = resolve)
            ]);
            document.getElementById('lottie-overlay').classList.add('fade-out');
            await webcontainerInstance.mount(files);

            const shellProcess = await webcontainerInstance.spawn('jsh', {
                terminal: { cols: mainTerm.cols, rows: mainTerm.rows }
            });

            const input = shellProcess.input.getWriter();
            mainTerm.onData(data => input.write(data));

            shellProcess.output.pipeTo(new WritableStream({
                write(data) {
                    if (data.includes('[[GUI:')) {
                        const start = data.indexOf('[[GUI:');
                        const end = data.indexOf(']]', start);
                        if (start !== -1 && end !== -1) {
                            try {
                                const config = JSON.parse(data.substring(start + 6, end));
                                windowManager.createDialog(config.title, config.html);
                                const clean = data.replace(/\[\[GUI:.*\]\]/, '');
                                mainTerm.write(clean);
                                bgTerm.write(clean);
                                return;
                            } catch (e) {}
                        }
                    }
                    mainTerm.write(data);
                    bgTerm.write(data);
                }
            }));

            await input.write("alias help='node help.js'\n");
            await input.write("alias HanGUI='node hangui.js'\n");
            mainTerm.write('\x1b[32m✔ ZhiliuOS Ready.\x1b[0m\r\n');
        });
    </script>
</body>
</html>